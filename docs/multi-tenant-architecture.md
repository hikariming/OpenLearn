# OpenLearn å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

OpenLearn é‡‡ç”¨å¤šç§Ÿæˆ·ï¼ˆMulti-Tenantï¼‰æ¶æ„è®¾è®¡ï¼Œå…è®¸ä¸åŒçš„ç”¨æˆ·æˆ–ç»„ç»‡ï¼ˆç§Ÿæˆ·ï¼‰å…±äº«åŒä¸€åº”ç”¨å®ä¾‹ï¼ŒåŒæ—¶ä¿æŒæ•°æ®éš”ç¦»å’Œå®‰å…¨æ€§ã€‚æœ¬è®¾è®¡å‚è€ƒäº† Dify çš„æˆç†Ÿå¤šç§Ÿæˆ·æ¶æ„å®è·µã€‚

**æ ¸å¿ƒç›®æ ‡ï¼š**
- âœ… **æ•°æ®éš”ç¦»**ï¼šç¡®ä¿ä¸åŒç§Ÿæˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°
- âœ… **çµæ´»åˆ‡æ¢**ï¼šç”¨æˆ·å¯ä»¥è½»æ¾åœ¨ä¸åŒç§Ÿæˆ·ï¼ˆç©ºé—´ï¼‰ä¹‹é—´åˆ‡æ¢
- âœ… **æƒé™æ§åˆ¶**ï¼šæ”¯æŒç§Ÿæˆ·å†…çš„ç»†ç²’åº¦è§’è‰²å’Œæƒé™ç®¡ç†
- âœ… **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥å¤§è§„æ¨¡ç§Ÿæˆ·å¢é•¿
- âœ… **æˆæœ¬ä¼˜åŒ–**ï¼šå…±äº«åŸºç¡€è®¾æ–½ï¼Œé™ä½è¿è¥æˆæœ¬

### 1.2 åº”ç”¨åœºæ™¯

- **ä¸ªäººç©ºé—´**ï¼šæ¯ä¸ªç”¨æˆ·æ‹¥æœ‰è‡ªå·±çš„ç§æœ‰å­¦ä¹ ç©ºé—´
- **å›¢é˜Ÿåä½œ**ï¼šæ•™è‚²æœºæ„ã€å­¦ä¹ å°ç»„å¯ä»¥åˆ›å»ºå…±äº«ç©ºé—´
- **ä¼ä¸šåŸ¹è®­**ï¼šä¼ä¸šå¯ä»¥ä¸ºä¸åŒéƒ¨é—¨åˆ›å»ºç‹¬ç«‹çš„åŸ¹è®­ç©ºé—´
- **å¤šé¡¹ç›®ç®¡ç†**ï¼šç”¨æˆ·å¯ä»¥ä¸ºä¸åŒå­¦ä¹ é¡¹ç›®åˆ›å»ºç‹¬ç«‹ç©ºé—´

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 ç§Ÿæˆ·ï¼ˆTenant / Workspaceï¼‰

**ç§Ÿæˆ·**æ˜¯æ•°æ®éš”ç¦»çš„åŸºæœ¬å•ä½ï¼Œåœ¨ OpenLearn ä¸­ç§°ä¸º"ç©ºé—´"ï¼ˆSpaceï¼‰ã€‚

**ç‰¹æ€§ï¼š**
- æ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®ç©ºé—´
- å¯ä»¥æœ‰å¤šä¸ªæˆå‘˜
- æœ‰ç‹¬ç«‹çš„é…ç½®å’Œæƒé™è®¾ç½®
- æ”¯æŒä¸åŒçš„è®¢é˜…è®¡åˆ’ï¼ˆFreeã€Proã€Enterpriseï¼‰

### 2.2 ç”¨æˆ·ï¼ˆUser / Accountï¼‰

**ç”¨æˆ·**æ˜¯ç³»ç»Ÿçš„åŸºæœ¬è´¦æˆ·å•ä½ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥ï¼š
- å±äºå¤šä¸ªç§Ÿæˆ·
- åœ¨ä¸åŒç§Ÿæˆ·ä¸­æ‹¥æœ‰ä¸åŒçš„è§’è‰²
- åˆ›å»ºå’Œæ‹¥æœ‰è‡ªå·±çš„ç§Ÿæˆ·
- åœ¨ç§Ÿæˆ·ä¹‹é—´è‡ªç”±åˆ‡æ¢

### 2.3 ç§Ÿæˆ·æˆå‘˜ï¼ˆTenantMemberï¼‰

**ç§Ÿæˆ·æˆå‘˜**å®šä¹‰äº†ç”¨æˆ·ä¸ç§Ÿæˆ·çš„å…³ç³»ï¼ŒåŒ…æ‹¬ï¼š
- ç”¨æˆ·åœ¨ç§Ÿæˆ·ä¸­çš„è§’è‰²
- ç”¨æˆ·çš„è®¿é—®æƒé™
- å½“å‰æ¿€æ´»çš„ç§Ÿæˆ·æ ‡è¯†

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

åŸºäº Dify çš„æœ€ä½³å®è·µï¼ŒOpenLearn é‡‡ç”¨ **"å…±äº«æ•°æ®åº“ï¼Œå…±äº«æ¨¡å¼"ï¼ˆShared Database, Shared Schemaï¼‰** çš„å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼ã€‚

#### 3.1.1 ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

```prisma
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  name              String
  password          String?   // Nullable for SSO users
  passwordSalt      String?   @map("password_salt")
  avatar            String?
  interfaceLanguage String?   @map("interface_language")
  timezone          String?
  lastLoginAt       DateTime? @map("last_login_at")
  lastLoginIp       String?   @map("last_login_ip")
  status            String    @default("active") // active, banned, closed
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relationships
  tenants           TenantMember[]
  ownedTenants      Tenant[]       @relation("TenantOwner")
  accounts          Account[]      // SSO Accounts

  @@map("users")
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `id`: ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `email`: ç™»å½•é‚®ç®±ï¼Œå…¨å±€å”¯ä¸€
- `name`: ç”¨æˆ·æ˜¾ç¤ºåç§°
- `password/passwordSalt`: å¯†ç å“ˆå¸Œå’Œç›å€¼
- `status`: è´¦æˆ·çŠ¶æ€ï¼ˆactive/banned/closedï¼‰
- `interfaceLanguage`: ç”¨æˆ·ç•Œé¢è¯­è¨€åå¥½
- `lastLoginAt/lastLoginIp`: ç™»å½•è¿½è¸ª

#### 3.1.2 ç§Ÿæˆ·è¡¨ï¼ˆtenantsï¼‰

```prisma
model Tenant {
  id               String   @id @default(uuid())
  name             String
  plan             String   @default("basic")
  status           String   @default("normal")
  encryptPublicKey String?  @map("encrypt_public_key")
  customConfig     String?  @map("custom_config") // JSON string
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relationships
  members          TenantMember[]
  ownerId          String?        @map("owner_id")
  owner            User?          @relation("TenantOwner", fields: [ownerId], references: [id])

  @@map("tenants")
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `id`: ç§Ÿæˆ·å”¯ä¸€æ ‡è¯†
- `name`: ç§Ÿæˆ·åç§°ï¼ˆå¦‚ "rqq's Space"ï¼‰
- `plan`: è®¢é˜…è®¡åˆ’ï¼ˆbasic/pro/enterpriseï¼‰
- `status`: ç§Ÿæˆ·çŠ¶æ€ï¼ˆnormal/suspended/archivedï¼‰
- `ownerId`: ç§Ÿæˆ·æ‰€æœ‰è€…ï¼ˆåˆ›å»ºè€…ï¼‰
- `customConfig`: ç§Ÿæˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆJSON æ ¼å¼ï¼‰
- `encryptPublicKey`: åŠ å¯†å…¬é’¥ï¼ˆç”¨äºæ•æ„Ÿæ•°æ®åŠ å¯†ï¼‰

#### 3.1.3 ç§Ÿæˆ·æˆå‘˜è¡¨ï¼ˆtenant_membersï¼‰

```prisma
model TenantMember {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  userId    String   @map("user_id")
  role      String   @default("normal") // owner, admin, editor, normal
  current   Boolean  @default(false)    // æ˜¯å¦ä¸ºç”¨æˆ·å½“å‰æ¿€æ´»çš„ç§Ÿæˆ·
  invitedBy String?  @map("invited_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([tenantId, userId])
  @@map("tenant_members")
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `tenantId`: å…³è”çš„ç§Ÿæˆ· ID
- `userId`: å…³è”çš„ç”¨æˆ· ID
- `role`: ç”¨æˆ·åœ¨ç§Ÿæˆ·ä¸­çš„è§’è‰²
  - `owner`: æ‰€æœ‰è€…ï¼ˆåˆ›å»ºè€…ï¼‰
  - `admin`: ç®¡ç†å‘˜
  - `editor`: ç¼–è¾‘è€…
  - `normal`: æ™®é€šæˆå‘˜
- `current`: æ ‡è¯†è¯¥ç§Ÿæˆ·æ˜¯å¦ä¸ºç”¨æˆ·å½“å‰æ¿€æ´»çš„ç§Ÿæˆ·
- `invitedBy`: é‚€è¯·äºº IDï¼ˆç”¨äºè¿½è¸ªé‚€è¯·é“¾ï¼‰

### 3.2 ä¸šåŠ¡æ•°æ®è¡¨è®¾è®¡

æ‰€æœ‰ä¸šåŠ¡æ•°æ®è¡¨éƒ½éœ€è¦åŒ…å« `tenantId` å­—æ®µä»¥å®ç°æ•°æ®éš”ç¦»ã€‚

#### 3.2.1 å­¦ä¹ å†…å®¹è¡¨ç¤ºä¾‹

```prisma
model LearningContent {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")  // ğŸ”‘ ç§Ÿæˆ·éš”ç¦»å­—æ®µ
  title       String
  content     String   @db.Text
  type        String   // pdf, video, chat, etc.
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  creator     User     @relation(fields: [createdBy], references: [id])

  @@index([tenantId])  // ğŸ”‘ å¿…é¡»ä¸º tenantId åˆ›å»ºç´¢å¼•
  @@map("learning_contents")
}
```

#### 3.2.2 çŸ¥è¯†åº“è¡¨ç¤ºä¾‹

```prisma
model KnowledgeBase {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")  // ğŸ”‘ ç§Ÿæˆ·éš”ç¦»å­—æ®µ
  name        String
  description String?
  type        String   // document, url, api
  config      String?  @db.Text // JSON configuration
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  documents   Document[]

  @@index([tenantId])  // ğŸ”‘ å¿…é¡»ä¸º tenantId åˆ›å»ºç´¢å¼•
  @@map("knowledge_bases")
}
```

### 3.3 æ•°æ®éš”ç¦»åŸåˆ™

> [!IMPORTANT]
> **æ‰€æœ‰ä¸šåŠ¡æ•°æ®è¡¨å¿…é¡»éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š**

1. **å¿…é¡»åŒ…å« `tenantId` å­—æ®µ**
   ```prisma
   tenantId String @map("tenant_id")
   ```

2. **å¿…é¡»ä¸º `tenantId` åˆ›å»ºç´¢å¼•**
   ```prisma
   @@index([tenantId])
   ```

3. **æ‰€æœ‰æŸ¥è¯¢å¿…é¡»åŒ…å«ç§Ÿæˆ·è¿‡æ»¤**
   ```typescript
   // âœ… æ­£ç¡®
   await prisma.learningContent.findMany({
     where: { tenantId: currentTenantId }
   });

   // âŒ é”™è¯¯ - ç¼ºå°‘ç§Ÿæˆ·è¿‡æ»¤
   await prisma.learningContent.findMany();
   ```

4. **å¤–é”®å…³ç³»éœ€è¦è€ƒè™‘ç§Ÿæˆ·è¾¹ç•Œ**
   - åŒä¸€ç§Ÿæˆ·å†…çš„æ•°æ®å¯ä»¥ç›¸äº’å¼•ç”¨
   - è·¨ç§Ÿæˆ·çš„æ•°æ®å¼•ç”¨éœ€è¦ç‰¹æ®Šå¤„ç†

---

## 4. API è®¾è®¡

### 4.1 ç§Ÿæˆ·ä¸Šä¸‹æ–‡è·å–

#### 4.1.1 ä»è¯·æ±‚ä¸­è·å–å½“å‰ç§Ÿæˆ·

```typescript
// src/common/decorators/current-tenant.decorator.ts
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const CurrentTenant = createParamDecorator(
  (data: unknown, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    return request.currentTenant;
  },
);
```

#### 4.1.2 ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­é—´ä»¶

```typescript
// src/common/middleware/tenant-context.middleware.ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
import { PrismaService } from '@/prisma/prisma.service';

@Injectable()
export class TenantContextMiddleware implements NestMiddleware {
  constructor(private prisma: PrismaService) {}

  async use(req: Request, res: Response, next: NextFunction) {
    const userId = req.user?.id; // ä» JWT ä¸­è·å–
    
    if (!userId) {
      return next();
    }

    // è·å–ç”¨æˆ·å½“å‰æ¿€æ´»çš„ç§Ÿæˆ·
    const currentMembership = await this.prisma.tenantMember.findFirst({
      where: {
        userId,
        current: true,
      },
      include: {
        tenant: true,
      },
    });

    if (currentMembership) {
      req['currentTenant'] = currentMembership.tenant;
      req['currentTenantId'] = currentMembership.tenantId;
      req['currentRole'] = currentMembership.role;
    }

    next();
  }
}
```

### 4.2 ç§Ÿæˆ·ç®¡ç† API

#### 4.2.1 åˆ›å»ºç§Ÿæˆ·ï¼ˆç©ºé—´ï¼‰

```typescript
POST /api/tenants

Request:
{
  "name": "æˆ‘çš„å­¦ä¹ ç©ºé—´"
}

Response:
{
  "id": "uuid",
  "name": "æˆ‘çš„å­¦ä¹ ç©ºé—´",
  "plan": "basic",
  "status": "normal",
  "role": "owner",
  "createdAt": "2025-11-23T10:00:00Z"
}
```

#### 4.2.2 è·å–ç”¨æˆ·çš„æ‰€æœ‰ç§Ÿæˆ·

```typescript
GET /api/tenants

Response:
{
  "tenants": [
    {
      "id": "uuid-1",
      "name": "rqq's Space",
      "role": "owner",
      "current": true,
      "memberCount": 1,
      "plan": "basic"
    },
    {
      "id": "uuid-2",
      "name": "å›¢é˜Ÿå­¦ä¹ ç©ºé—´",
      "role": "admin",
      "current": false,
      "memberCount": 5,
      "plan": "pro"
    }
  ]
}
```

#### 4.2.3 åˆ‡æ¢å½“å‰ç§Ÿæˆ·

```typescript
POST /api/tenants/:tenantId/switch

Response:
{
  "success": true,
  "currentTenant": {
    "id": "uuid",
    "name": "å›¢é˜Ÿå­¦ä¹ ç©ºé—´",
    "role": "admin"
  }
}
```

#### 4.2.4 é‚€è¯·æˆå‘˜

```typescript
POST /api/tenants/:tenantId/members

Request:
{
  "email": "user@example.com",
  "role": "editor"
}

Response:
{
  "id": "uuid",
  "email": "user@example.com",
  "role": "editor",
  "status": "pending"
}
```

### 4.3 ç§Ÿæˆ·éš”ç¦»çš„ä¸šåŠ¡ API

æ‰€æœ‰ä¸šåŠ¡ API éƒ½åº”è¯¥è‡ªåŠ¨åº”ç”¨ç§Ÿæˆ·è¿‡æ»¤ï¼š

```typescript
// src/modules/learning/learning.service.ts
@Injectable()
export class LearningService {
  constructor(private prisma: PrismaService) {}

  async findAll(tenantId: string) {
    return this.prisma.learningContent.findMany({
      where: { tenantId }, // ğŸ”‘ ç§Ÿæˆ·è¿‡æ»¤
    });
  }

  async create(tenantId: string, userId: string, data: CreateLearningDto) {
    return this.prisma.learningContent.create({
      data: {
        ...data,
        tenantId, // ğŸ”‘ è‡ªåŠ¨å…³è”ç§Ÿæˆ·
        createdBy: userId,
      },
    });
  }
}
```

---

## 5. å‰ç«¯å®ç°æ–¹æ¡ˆ

### 5.1 ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†

#### 5.1.1 ç§Ÿæˆ·ä¸Šä¸‹æ–‡ Provider

```typescript
// src/context/TenantContext.tsx
'use client';

import { createContext, useContext, useState, useEffect } from 'react';

interface Tenant {
  id: string;
  name: string;
  role: string;
  plan: string;
}

interface TenantContextType {
  currentTenant: Tenant | null;
  tenants: Tenant[];
  switchTenant: (tenantId: string) => Promise<void>;
  refreshTenants: () => Promise<void>;
}

const TenantContext = createContext<TenantContextType | undefined>(undefined);

export function TenantProvider({ children }: { children: React.ReactNode }) {
  const [currentTenant, setCurrentTenant] = useState<Tenant | null>(null);
  const [tenants, setTenants] = useState<Tenant[]>([]);

  const refreshTenants = async () => {
    const response = await fetch('/api/tenants');
    const data = await response.json();
    setTenants(data.tenants);
    
    const current = data.tenants.find((t: Tenant) => t.current);
    setCurrentTenant(current || null);
  };

  const switchTenant = async (tenantId: string) => {
    await fetch(`/api/tenants/${tenantId}/switch`, { method: 'POST' });
    await refreshTenants();
  };

  useEffect(() => {
    refreshTenants();
  }, []);

  return (
    <TenantContext.Provider value={{ currentTenant, tenants, switchTenant, refreshTenants }}>
      {children}
    </TenantContext.Provider>
  );
}

export const useTenant = () => {
  const context = useContext(TenantContext);
  if (!context) throw new Error('useTenant must be used within TenantProvider');
  return context;
};
```

### 5.2 Sidebar ç©ºé—´åˆ‡æ¢å®ç°

```tsx
// src/components/Sidebar.tsx
'use client';

import { useTenant } from '@/context/TenantContext';
import { Plus, Box, Check } from 'lucide-react';
import { useState } from 'react';

export default function Sidebar() {
  const { currentTenant, tenants, switchTenant } = useTenant();
  const [isSpaceMenuOpen, setIsSpaceMenuOpen] = useState(false);

  return (
    <div className="w-64 h-screen border-r flex flex-col bg-white">
      {/* ... å…¶ä»–å†…å®¹ ... */}

      {/* ç©ºé—´åˆ‡æ¢åŒºåŸŸ */}
      <div className="px-4 mb-6">
        <h3 className="text-xs font-bold text-gray-900 mb-2 px-2">ç©ºé—´</h3>
        
        {/* åˆ›å»ºç©ºé—´æŒ‰é’® */}
        <button className="flex items-center gap-3 text-gray-600 hover:bg-gray-50 w-full p-2 rounded-lg transition-colors">
          <Plus size={20} />
          <span>åˆ›é€ ç©ºé—´</span>
        </button>

        {/* å½“å‰ç©ºé—´ */}
        <div className="relative">
          <button
            onClick={() => setIsSpaceMenuOpen(!isSpaceMenuOpen)}
            className="flex items-center gap-3 text-gray-600 hover:bg-gray-50 w-full p-2 rounded-lg transition-colors"
          >
            <Box size={20} />
            <span className="flex-1 text-left truncate">
              {currentTenant?.name || 'é€‰æ‹©ç©ºé—´'}
            </span>
            <ChevronDown size={16} className={`transition-transform ${isSpaceMenuOpen ? 'rotate-180' : ''}`} />
          </button>

          {/* ç©ºé—´åˆ‡æ¢ä¸‹æ‹‰èœå• */}
          {isSpaceMenuOpen && (
            <div className="absolute top-full left-0 w-full bg-white border border-gray-100 shadow-lg rounded-lg mt-1 overflow-hidden z-10">
              <div className="p-1 max-h-64 overflow-y-auto">
                {tenants.map((tenant) => (
                  <button
                    key={tenant.id}
                    onClick={() => {
                      switchTenant(tenant.id);
                      setIsSpaceMenuOpen(false);
                    }}
                    className="flex items-center gap-3 w-full text-left px-3 py-2 hover:bg-gray-50 text-sm rounded transition-colors"
                  >
                    <Box size={16} />
                    <span className="flex-1 truncate">{tenant.name}</span>
                    {tenant.id === currentTenant?.id && (
                      <Check size={16} className="text-blue-600" />
                    )}
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>

      {/* ... å…¶ä»–å†…å®¹ ... */}
    </div>
  );
}
```

### 5.3 è‡ªåŠ¨ç§Ÿæˆ·è¿‡æ»¤çš„ API è°ƒç”¨

```typescript
// src/lib/api.ts
export async function fetchWithTenant(url: string, options?: RequestInit) {
  // å½“å‰ç§Ÿæˆ· ID ä¼šè‡ªåŠ¨ä» Cookie æˆ– JWT ä¸­è·å–
  // åç«¯ä¸­é—´ä»¶ä¼šè‡ªåŠ¨åº”ç”¨ç§Ÿæˆ·è¿‡æ»¤
  return fetch(url, {
    ...options,
    headers: {
      ...options?.headers,
      'Content-Type': 'application/json',
    },
  });
}

// ä½¿ç”¨ç¤ºä¾‹
const learningContents = await fetchWithTenant('/api/learning/contents');
// è¿”å›çš„æ•°æ®è‡ªåŠ¨é™åˆ¶åœ¨å½“å‰ç§Ÿæˆ·èŒƒå›´å†…
```

---

## 6. å®‰å…¨å’Œæƒé™æ§åˆ¶

### 6.1 ç§Ÿæˆ·éš”ç¦»å®‰å…¨æ£€æŸ¥

#### 6.1.1 ç§Ÿæˆ·è®¿é—®å®ˆå«

```typescript
// src/common/guards/tenant-access.guard.ts
import { Injectable, CanActivate, ExecutionContext, ForbiddenException } from '@nestjs/common';
import { PrismaService } from '@/prisma/prisma.service';

@Injectable()
export class TenantAccessGuard implements CanActivate {
  constructor(private prisma: PrismaService) {}

  async canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const userId = request.user?.id;
    const tenantId = request.currentTenantId;

    if (!userId || !tenantId) {
      throw new ForbiddenException('ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç¼ºå¤±');
    }

    // éªŒè¯ç”¨æˆ·æ˜¯å¦å±äºè¯¥ç§Ÿæˆ·
    const membership = await this.prisma.tenantMember.findUnique({
      where: {
        tenantId_userId: {
          tenantId,
          userId,
        },
      },
    });

    if (!membership) {
      throw new ForbiddenException('æ‚¨ä¸å±äºè¯¥ç§Ÿæˆ·');
    }

    return true;
  }
}
```

#### 6.1.2 è§’è‰²æƒé™å®ˆå«

```typescript
// src/common/guards/tenant-role.guard.ts
import { Injectable, CanActivate, ExecutionContext, ForbiddenException } from '@nestjs/common';
import { Reflector } from '@nestjs/core';

@Injectable()
export class TenantRoleGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.get<string[]>('roles', context.getHandler());
    if (!requiredRoles) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const userRole = request.currentRole;

    const roleHierarchy = {
      owner: 4,
      admin: 3,
      editor: 2,
      normal: 1,
    };

    const hasPermission = requiredRoles.some(
      (role) => roleHierarchy[userRole] >= roleHierarchy[role]
    );

    if (!hasPermission) {
      throw new ForbiddenException('æƒé™ä¸è¶³');
    }

    return true;
  }
}
```

#### 6.1.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
// src/modules/learning/learning.controller.ts
import { Controller, Get, Post, UseGuards } from '@nestjs/common';
import { TenantAccessGuard } from '@/common/guards/tenant-access.guard';
import { TenantRoleGuard } from '@/common/guards/tenant-role.guard';
import { Roles } from '@/common/decorators/roles.decorator';
import { CurrentTenant } from '@/common/decorators/current-tenant.decorator';

@Controller('learning')
@UseGuards(TenantAccessGuard)
export class LearningController {
  // æ‰€æœ‰æˆå‘˜éƒ½å¯ä»¥æŸ¥çœ‹
  @Get()
  async findAll(@CurrentTenant() tenantId: string) {
    return this.learningService.findAll(tenantId);
  }

  // åªæœ‰ editor åŠä»¥ä¸Šè§’è‰²å¯ä»¥åˆ›å»º
  @Post()
  @UseGuards(TenantRoleGuard)
  @Roles('editor')
  async create(@CurrentTenant() tenantId: string, @Body() data: CreateLearningDto) {
    return this.learningService.create(tenantId, data);
  }

  // åªæœ‰ admin åŠä»¥ä¸Šè§’è‰²å¯ä»¥åˆ é™¤
  @Delete(':id')
  @UseGuards(TenantRoleGuard)
  @Roles('admin')
  async delete(@Param('id') id: string) {
    return this.learningService.delete(id);
  }
}
```

### 6.2 æ•°æ®è®¿é—®å®‰å…¨åŸåˆ™

> [!CAUTION]
> **ä¸¥æ ¼éµå®ˆä»¥ä¸‹å®‰å…¨åŸåˆ™ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²ï¼š**

1. **æ°¸è¿œä¸è¦ä¿¡ä»»å‰ç«¯ä¼ æ¥çš„ `tenantId`**
   ```typescript
   // âŒ å±é™© - å‰ç«¯å¯ä»¥ä¼ªé€  tenantId
   async findAll(@Body() { tenantId }: any) {
     return this.prisma.learningContent.findMany({ where: { tenantId } });
   }

   // âœ… å®‰å…¨ - ä»è®¤è¯ä¸Šä¸‹æ–‡è·å–
   async findAll(@CurrentTenant() tenantId: string) {
     return this.prisma.learningContent.findMany({ where: { tenantId } });
   }
   ```

2. **æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢å¿…é¡»åŒ…å«ç§Ÿæˆ·è¿‡æ»¤**
   ```typescript
   // âŒ å±é™© - å¯èƒ½æ³„éœ²å…¶ä»–ç§Ÿæˆ·æ•°æ®
   await prisma.learningContent.findUnique({ where: { id } });

   // âœ… å®‰å…¨ - åŒæ—¶éªŒè¯ç§Ÿæˆ·
   await prisma.learningContent.findFirst({
     where: { id, tenantId: currentTenantId }
   });
   ```

3. **è·¨ç§Ÿæˆ·æ“ä½œéœ€è¦æ˜ç¡®æˆæƒ**
   - ç³»ç»Ÿç®¡ç†å‘˜æ“ä½œéœ€è¦ç‰¹æ®Šæƒé™
   - è®°å½•æ‰€æœ‰è·¨ç§Ÿæˆ·è®¿é—®æ—¥å¿—

4. **æ•æ„Ÿé…ç½®ä½¿ç”¨ç§Ÿæˆ·çº§åŠ å¯†**
   ```typescript
   // ä½¿ç”¨ç§Ÿæˆ·çš„ encryptPublicKey åŠ å¯†æ•æ„Ÿæ•°æ®
   const encrypted = encrypt(sensitiveData, tenant.encryptPublicKey);
   ```

---

## 7. å®æ–½è·¯çº¿å›¾

### 7.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å¤šç§Ÿæˆ·åŠŸèƒ½ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] æ•°æ®åº“æ¨¡å‹è®¾è®¡ï¼ˆUserã€Tenantã€TenantMemberï¼‰
- [x] Prisma Schema å®šä¹‰
- [x] åŸºç¡€è¡¨ç»“æ„åˆ›å»º

### 7.2 ç¬¬äºŒé˜¶æ®µï¼šåç«¯ API å®ç°ï¼ˆå¾…å®æ–½ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **ç§Ÿæˆ·ç®¡ç†æ¨¡å—**
  - [ ] åˆ›å»ºç§Ÿæˆ· API
  - [ ] è·å–ç”¨æˆ·ç§Ÿæˆ·åˆ—è¡¨ API
  - [ ] åˆ‡æ¢å½“å‰ç§Ÿæˆ· API
  - [ ] æ›´æ–°ç§Ÿæˆ·ä¿¡æ¯ API
  - [ ] åˆ é™¤ç§Ÿæˆ· API

- [ ] **æˆå‘˜ç®¡ç†æ¨¡å—**
  - [ ] é‚€è¯·æˆå‘˜ API
  - [ ] ç§»é™¤æˆå‘˜ API
  - [ ] æ›´æ–°æˆå‘˜è§’è‰² API
  - [ ] è·å–ç§Ÿæˆ·æˆå‘˜åˆ—è¡¨ API

- [ ] **ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­é—´ä»¶**
  - [ ] å®ç° TenantContextMiddleware
  - [ ] å®ç° CurrentTenant è£…é¥°å™¨
  - [ ] å®ç° TenantAccessGuard
  - [ ] å®ç° TenantRoleGuard

- [ ] **ä¸šåŠ¡æ•°æ®è¡¨è¿ç§»**
  - [ ] ä¸ºç°æœ‰ä¸šåŠ¡è¡¨æ·»åŠ  `tenantId` å­—æ®µ
  - [ ] åˆ›å»ºå¿…è¦çš„ç´¢å¼•
  - [ ] æ•°æ®è¿ç§»è„šæœ¬ï¼ˆå¦‚æœ‰ç°æœ‰æ•°æ®ï¼‰

#### é¢„ä¼°æ—¶é—´ï¼š2-3 å‘¨

### 7.3 ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯é›†æˆï¼ˆå¾…å®æ–½ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†**
  - [ ] å®ç° TenantContext Provider
  - [ ] å®ç° useTenant Hook
  - [ ] å…¨å±€çŠ¶æ€ç®¡ç†é›†æˆ

- [ ] **Sidebar ç©ºé—´åˆ‡æ¢**
  - [ ] ç©ºé—´åˆ—è¡¨å±•ç¤º
  - [ ] ç©ºé—´åˆ‡æ¢äº¤äº’
  - [ ] åˆ›å»ºç©ºé—´å¯¹è¯æ¡†
  - [ ] å½“å‰ç©ºé—´é«˜äº®æ˜¾ç¤º

- [ ] **ç§Ÿæˆ·ç®¡ç†é¡µé¢**
  - [ ] ç§Ÿæˆ·è®¾ç½®é¡µé¢
  - [ ] æˆå‘˜ç®¡ç†ç•Œé¢
  - [ ] é‚€è¯·æˆå‘˜åŠŸèƒ½
  - [ ] è§’è‰²æƒé™ç®¡ç†

- [ ] **API è°ƒç”¨é€‚é…**
  - [ ] å°è£…ç§Ÿæˆ·æ„ŸçŸ¥çš„ API å®¢æˆ·ç«¯
  - [ ] æ›´æ–°ç°æœ‰ API è°ƒç”¨
  - [ ] é”™è¯¯å¤„ç†å’Œæç¤º

#### é¢„ä¼°æ—¶é—´ï¼š2-3 å‘¨

### 7.4 ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆå¾…å®æ–½ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **å•å…ƒæµ‹è¯•**
  - [ ] ç§Ÿæˆ·ç®¡ç†æœåŠ¡æµ‹è¯•
  - [ ] æƒé™å®ˆå«æµ‹è¯•
  - [ ] æ•°æ®éš”ç¦»æµ‹è¯•

- [ ] **é›†æˆæµ‹è¯•**
  - [ ] ç§Ÿæˆ·åˆ‡æ¢æµç¨‹æµ‹è¯•
  - [ ] è·¨ç§Ÿæˆ·æ•°æ®éš”ç¦»æµ‹è¯•
  - [ ] æƒé™æ§åˆ¶æµ‹è¯•

- [ ] **æ€§èƒ½ä¼˜åŒ–**
  - [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
  - [ ] ç´¢å¼•ä¼˜åŒ–
  - [ ] ç¼“å­˜ç­–ç•¥

- [ ] **å®‰å…¨å®¡è®¡**
  - [ ] æ•°æ®éš”ç¦»éªŒè¯
  - [ ] æƒé™æ§åˆ¶å®¡æŸ¥
  - [ ] å®‰å…¨æ¼æ´æ‰«æ

#### é¢„ä¼°æ—¶é—´ï¼š1-2 å‘¨

### 7.5 ç¬¬äº”é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½ï¼ˆæœªæ¥è§„åˆ’ï¼‰

- [ ] **ç§Ÿæˆ·çº§é…é¢ç®¡ç†**
  - [ ] å­˜å‚¨ç©ºé—´é™åˆ¶
  - [ ] API è°ƒç”¨é¢‘ç‡é™åˆ¶
  - [ ] æˆå‘˜æ•°é‡é™åˆ¶

- [ ] **ç§Ÿæˆ·çº§åˆ†æ**
  - [ ] ä½¿ç”¨ç»Ÿè®¡
  - [ ] æˆå‘˜æ´»è·ƒåº¦
  - [ ] èµ„æºæ¶ˆè€—åˆ†æ

- [ ] **è·¨ç§Ÿæˆ·åä½œ**
  - [ ] å†…å®¹åˆ†äº«
  - [ ] è·¨ç©ºé—´å¼•ç”¨
  - [ ] å…¬å¼€èµ„æºåº“

- [ ] **ç§Ÿæˆ·è¿ç§»å·¥å…·**
  - [ ] æ•°æ®å¯¼å‡º
  - [ ] æ•°æ®å¯¼å…¥
  - [ ] ç§Ÿæˆ·åˆå¹¶

#### é¢„ä¼°æ—¶é—´ï¼šæŒ‰éœ€å®æ–½

---

## 8. æœ€ä½³å®è·µæ€»ç»“

### 8.1 å¼€å‘è§„èŒƒ

1. **æ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»åŒ…å« `tenantId`**
   - æ–°å»ºè¡¨æ—¶é»˜è®¤æ·»åŠ 
   - ä¸º `tenantId` åˆ›å»ºç´¢å¼•

2. **æ‰€æœ‰æŸ¥è¯¢å¿…é¡»åŒ…å«ç§Ÿæˆ·è¿‡æ»¤**
   - ä½¿ç”¨è£…é¥°å™¨è‡ªåŠ¨æ³¨å…¥
   - ä»£ç å®¡æŸ¥æ—¶é‡ç‚¹æ£€æŸ¥

3. **ä½¿ç”¨ç±»å‹å®‰å…¨çš„ API**
   - åˆ©ç”¨ TypeScript ç±»å‹ç³»ç»Ÿ
   - é¿å…ä½¿ç”¨ `any` ç±»å‹

4. **ç¼–å†™å®Œæ•´çš„æµ‹è¯•**
   - å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
   - é›†æˆæµ‹è¯•éªŒè¯æ•°æ®éš”ç¦»

### 8.2 æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ç´¢å¼•ç­–ç•¥**
   ```sql
   -- å¿…é¡»ä¸º tenantId åˆ›å»ºç´¢å¼•
   CREATE INDEX idx_learning_contents_tenant_id ON learning_contents(tenant_id);
   
   -- ç»„åˆç´¢å¼•ä¼˜åŒ–å¸¸è§æŸ¥è¯¢
   CREATE INDEX idx_learning_contents_tenant_created 
   ON learning_contents(tenant_id, created_at DESC);
   ```

2. **æŸ¥è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨ Prisma çš„ `select` å‡å°‘æ•°æ®ä¼ è¾“
   - åˆç†ä½¿ç”¨ `include` é¿å… N+1 æŸ¥è¯¢
   - è€ƒè™‘ä½¿ç”¨æ•°æ®åº“è§†å›¾

3. **ç¼“å­˜ç­–ç•¥**
   ```typescript
   // ç¼“å­˜ç§Ÿæˆ·ä¿¡æ¯
   const tenant = await cache.get(`tenant:${tenantId}`, async () => {
     return prisma.tenant.findUnique({ where: { id: tenantId } });
   });
   ```

### 8.3 ç›‘æ§å’Œæ—¥å¿—

1. **ç§Ÿæˆ·çº§æ—¥å¿—**
   ```typescript
   logger.info('Learning content created', {
     tenantId,
     userId,
     contentId,
   });
   ```

2. **æ€§èƒ½ç›‘æ§**
   - ç›‘æ§æ¯ä¸ªç§Ÿæˆ·çš„æŸ¥è¯¢æ€§èƒ½
   - è¯†åˆ«æ…¢æŸ¥è¯¢å¹¶ä¼˜åŒ–

3. **å®‰å…¨å®¡è®¡æ—¥å¿—**
   - è®°å½•æ‰€æœ‰ç§Ÿæˆ·åˆ‡æ¢æ“ä½œ
   - è®°å½•æƒé™å˜æ›´
   - è®°å½•è·¨ç§Ÿæˆ·è®¿é—®å°è¯•

---

## 9. å‚è€ƒèµ„æ–™

### 9.1 Dify å¤šç§Ÿæˆ·æ¶æ„

- **æ ¸å¿ƒè¡¨ç»“æ„**ï¼š`tenants`ã€`accounts`ã€`tenant_account_joins`
- **æ•°æ®éš”ç¦»æ¨¡å¼**ï¼šShared Database, Shared Schema with Tenant Discriminator
- **æ•°æ®åº“æŠ€æœ¯**ï¼šPostgreSQL + Vector Database
- **æ¶æ„æ¼”è¿›**ï¼šä»å¤šå®¹å™¨åˆ°ç»Ÿä¸€ TiDB Cloud

### 9.2 å¤šç§Ÿæˆ·è®¾è®¡æ¨¡å¼

1. **Shared Database, Shared Schema**ï¼ˆå½“å‰é‡‡ç”¨ï¼‰
   - âœ… æˆæœ¬æœ€ä½
   - âœ… ç»´æŠ¤ç®€å•
   - âœ… é€‚åˆå¤§è§„æ¨¡ç§Ÿæˆ·
   - âš ï¸ éœ€è¦ä¸¥æ ¼çš„æ•°æ®éš”ç¦»æ§åˆ¶

2. **Shared Database, Separate Schemas**
   - âœ… æ›´å¥½çš„æ•°æ®éš”ç¦»
   - âŒ ç»´æŠ¤å¤æ‚åº¦é«˜
   - âŒ æ‰©å±•æ€§å—é™

3. **Separate Databases**
   - âœ… æœ€å¼ºçš„æ•°æ®éš”ç¦»
   - âŒ æˆæœ¬æœ€é«˜
   - âŒ ç»´æŠ¤å¤æ‚åº¦æœ€é«˜

### 9.3 ç›¸å…³æŠ€æœ¯æ–‡æ¡£

- [Prisma Multi-Tenancy Guide](https://www.prisma.io/docs/guides/database/multi-tenancy)
- [NestJS Guards Documentation](https://docs.nestjs.com/guards)
- [PostgreSQL Row-Level Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)

---

## 10. é™„å½•

### 10.1 å®Œæ•´çš„ Prisma Schema ç¤ºä¾‹

å‚è§ï¼š[`app/server/prisma/schema.prisma`](file:///Users/rqq/openlearn/app/server/prisma/schema.prisma)

### 10.2 API ç«¯ç‚¹æ¸…å•

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | æƒé™ |
|------|------|------|------|
| `/api/tenants` | GET | è·å–ç”¨æˆ·çš„æ‰€æœ‰ç§Ÿæˆ· | å·²è®¤è¯ |
| `/api/tenants` | POST | åˆ›å»ºæ–°ç§Ÿæˆ· | å·²è®¤è¯ |
| `/api/tenants/:id` | GET | è·å–ç§Ÿæˆ·è¯¦æƒ… | ç§Ÿæˆ·æˆå‘˜ |
| `/api/tenants/:id` | PATCH | æ›´æ–°ç§Ÿæˆ·ä¿¡æ¯ | admin+ |
| `/api/tenants/:id` | DELETE | åˆ é™¤ç§Ÿæˆ· | owner |
| `/api/tenants/:id/switch` | POST | åˆ‡æ¢å½“å‰ç§Ÿæˆ· | ç§Ÿæˆ·æˆå‘˜ |
| `/api/tenants/:id/members` | GET | è·å–æˆå‘˜åˆ—è¡¨ | ç§Ÿæˆ·æˆå‘˜ |
| `/api/tenants/:id/members` | POST | é‚€è¯·æˆå‘˜ | admin+ |
| `/api/tenants/:id/members/:userId` | PATCH | æ›´æ–°æˆå‘˜è§’è‰² | admin+ |
| `/api/tenants/:id/members/:userId` | DELETE | ç§»é™¤æˆå‘˜ | admin+ |

### 10.3 è§’è‰²æƒé™çŸ©é˜µ

| æ“ä½œ | owner | admin | editor | normal |
|------|-------|-------|--------|--------|
| æŸ¥çœ‹å†…å®¹ | âœ… | âœ… | âœ… | âœ… |
| åˆ›å»ºå†…å®¹ | âœ… | âœ… | âœ… | âŒ |
| ç¼–è¾‘è‡ªå·±çš„å†…å®¹ | âœ… | âœ… | âœ… | âŒ |
| ç¼–è¾‘ä»–äººçš„å†…å®¹ | âœ… | âœ… | âœ… | âŒ |
| åˆ é™¤å†…å®¹ | âœ… | âœ… | âŒ | âŒ |
| é‚€è¯·æˆå‘˜ | âœ… | âœ… | âŒ | âŒ |
| ç§»é™¤æˆå‘˜ | âœ… | âœ… | âŒ | âŒ |
| ä¿®æ”¹æˆå‘˜è§’è‰² | âœ… | âœ… | âŒ | âŒ |
| ä¿®æ”¹ç§Ÿæˆ·è®¾ç½® | âœ… | âœ… | âŒ | âŒ |
| åˆ é™¤ç§Ÿæˆ· | âœ… | âŒ | âŒ | âŒ |
| è½¬è®©æ‰€æœ‰æƒ | âœ… | âŒ | âŒ | âŒ |

---

## 11. æ€»ç»“

OpenLearn çš„å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡å‚è€ƒäº† Dify çš„æˆç†Ÿå®è·µï¼Œé‡‡ç”¨"å…±äº«æ•°æ®åº“ï¼Œå…±äº«æ¨¡å¼"çš„è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡ `tenantId` å­—æ®µå®ç°æ•°æ®éš”ç¦»ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- ğŸ¯ **çµæ´»æ€§**ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºå¤šä¸ªç©ºé—´ï¼Œåœ¨ä¸åŒç©ºé—´ä¹‹é—´è‡ªç”±åˆ‡æ¢
- ğŸ”’ **å®‰å…¨æ€§**ï¼šä¸¥æ ¼çš„æ•°æ®éš”ç¦»å’Œæƒé™æ§åˆ¶
- ğŸ“ˆ **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤§è§„æ¨¡ç§Ÿæˆ·å¢é•¿
- ğŸ’° **æˆæœ¬ä¼˜åŒ–**ï¼šå…±äº«åŸºç¡€è®¾æ–½ï¼Œé™ä½è¿è¥æˆæœ¬

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š**
1. å®¡æŸ¥å¹¶ç¡®è®¤æœ¬è®¾è®¡æ–‡æ¡£
2. å¼€å§‹å®æ–½ç¬¬äºŒé˜¶æ®µï¼šåç«¯ API å¼€å‘
3. é€æ­¥å®Œæˆå‰ç«¯é›†æˆå’Œæµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-23  
**æœ€åæ›´æ–°**ï¼š2025-11-23  
**ç»´æŠ¤è€…**ï¼šOpenLearn Team
